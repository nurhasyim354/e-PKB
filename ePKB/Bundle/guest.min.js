app.config(function(n,t,i){n.when("/",{templateUrl:"/Guest/views/home.html?v="+i.ver,title:"e-PKB",controller:"homeController"}).when("/login",{templateUrl:"/Guest/views/login.html?v="+i.ver,title:"Login",controller:"userController"}).when("/forgotpassword",{templateUrl:"/Guest/views/login.html?v="+i.ver,name:"Forgot Password",controller:"userController"}).when("/update/password",{templateUrl:"/Guest/views/update.html?v="+i.ver,name:"Update Password",controller:"userController"}).when("/step1",{templateUrl:"/Guest/views/data.html?v="+i.ver,title:"Lengkapi Data",controller:"step1Controller"}).when("/step2/:sub",{templateUrl:"/Guest/views/upload.html?v="+i.ver,title:"Upload Dokumen",controller:"step2Controller"}).when("/step3/:sub",{templateUrl:"/Guest/views/payment.html?v="+i.ver,title:"Pembayaran",controller:"step3Controller"}).when("/step4/:sub",{templateUrl:"/Guest/views/finish.html?v="+i.ver,title:"Ambil Bukti Setor Pajak",controller:"step4Controller"}).when("/profile",{templateUrl:"/Guest/views/profile.html?v="+i.ver,title:"Profile Pengguna",controller:"profileController"}).when("/admin/list",{templateUrl:"/Guest/views/admin_list.html?v="+i.ver,title:"Daftar Pembayaran PKB",controller:"adminListController",settings:{rolesPermitted:["admin"]}}).when("/admin/validatedata/:sub",{templateUrl:"/Guest/views/admin_validatedata.html?v="+i.ver,title:"Validasi Data",controller:"adminValidateController",settings:{rolesPermitted:["admin"]}}).when("/admin/confirmpayment/:sub",{templateUrl:"/Guest/views/admin_confirmpayment.html?v="+i.ver,title:"Konfirmasi Pembayaran",controller:"adminConfirmPaymentController",settings:{rolesPermitted:["admin"]}}).when("/404",{templateUrl:"/Guest/views/404.html?v="+i.ver,title:"Page not Found"}).otherwise({redirectTo:"/404"});t.html5Mode({enabled:!0,requireBase:!1})});app.run(function(n,t,i,r,u,f){n.constant=r;n.authService=u;n.appService=f;n.isLoading=!1;n.$on("$routeChangeStart",function(t,r){n.isLoading=!0;n.isAdmin=!1;r.originalPath&&(previousPath=r.originalPath.split(":"));var f=!1;r.settings&&r.settings.rolesPermitted&&r.settings.rolesPermitted.length>0?u.authentication.isAuth&&angular.forEach(u.authentication.user.Roles,function(n){f=$.inArray(n,r.settings.rolesPermitted)>-1}):f=!0;f||i.path("/login").search("returnUrl",previousPath[0])});n.$on("$routeChangeSuccess",function(r,u){n.isLoading=!1;n.activeTab=u.activeTab?u.activeTab:i.path();n.title=u.title;t();$("nav .navbar-collapse").hasClass("in")&&$("nav .navbar-toggle").trigger("click");swal.close();$(".modal").modal("hide")})});app.controller("homeController",function(n,t){n.isAdminLogin()&&t.path("/admin/list")});app.controller("step1Controller",function(n,t,i,r,u){n.currentStep=1;u.loadOption();u.loadProvinces();t.resources={};t.emailExist=!1;t.checkEmail=!1;t.register=!1;t.selectedVehicle={};t.doCheckEmail=function(n){if(!n){r.errorDialog("Silahkan ketik email anda!");return}var u={};u.email=n;i.post("/api/epkb/checkemail",u).then(function(n){t.checkEmail=!0;n.data?t.emailExist=!0:(t.emailExist=!1,t.register=!0)})};t.login=function(i){var r={};r.UserName=i.UserProfile.Email;r.Password=i.Password;n.authService.login(r).then(function(){t.fillUserData()})};t.reset=function(){t.emailExist=!1;t.checkEmail=!1;t.resources.UserProfile.Email=""};t.fillUserData=function(){u.loadUser(n.authService.authentication.user.Id).then(function(n){t.resources.UserProfile=n.data;t.logedin=!0})};t.save=function(n){t.logedin?u.saveData(n):u.saveRegistration(n).then(function(){t.login(n)},function(n){r.errorDialog(n.data.Message)})};t.openRegister=function(){t.register=!0};t.openVehicle=function(n){t.selectedVehicle=n;try{if(n.ExpireSTNKDate){var i=moment.utc(n.ExpireSTNKDate);i.local();n.ExpireSTNKDate=i}t.resources.Vehicle=n;angular.forEach(u.Provinces,function(t){n.Province==t.Name&&(n.Province=t)});angular.forEach(n.Province.Regions,function(t){n.IdRegion==t.Id&&(n.Region=t)})}catch(r){console.log(r)}};n.authService.authentication.isAuth&&t.fillUserData()});app.controller("profileController",function(n,t,i,r,u){var f=function(){var i={};i.id=r.authentication.user.Id;t.post("/api/epkb/userdata",i).then(function(t){n.resources={};n.resources.UserProfile=t.data;n.resources.TaxPayments=t.data.TaxPayments;n.resources.Vehicles=t.data.Vehicles})};n.do=function(n){switch(n.Status){case i.status_upload:u.path("/step2/"+n.Id);break;case i.status_validateData:case i.status_waitForPayment:u.path("/step3/"+n.Id);break;case i.status_print:u.path("/step4/"+n.Id);break;case i.status_confirmPayment:u.path("/step4/"+n.Id)}};f()});app.controller("step2Controller",function(n,t,i,r,u,f,e,o){n.currentStep=2;t.sub=i.sub;var h=i.sub,s=function(){var n={};n.id=h;f.post("/api/epkb/taxpayment",n).then(function(i){t.resources=i.data;t.Images=i.data.Images;n.regnumber=t.resources.RegNumber;f.post("/api/epkb/images",n).then(function(n){t.Images=n.data},function(n){swal("Oops!",n.data.Message,"info")})},function(n){u.error(n.data.Message)})};s();t.dragDrop=function(n,i){var u=[];angular.forEach(n.files,function(n){u.push(n.file)});r.upload(u,t.resources.RegNumber,t.resources.RegNumber+"_"+i).then(function(){s()},function(n){swal("Oops!",n.data.Message,"info")});n.files=[]};t.save=function(n){if(!n.ktp||!n.ktp.Path){u.errorDialog("Gambar KTP belum diupload!");return}if(!n.stnk||!n.stnk.Path){u.errorDialog("Gambar STNK belum diupload!");return}if(!n.ssp||!n.ssp.Path){u.errorDialog("Gambar Bukti Setor Pajak Tahun Terakhir belum diupload!");return}if(!n.bpkb||!n.bpkb.Path){u.errorDialog("Gambar BPKB belum diupload!");return}var i={};i.id=t.resources.Id;i.status=o.status_validateData;f.post("/api/epkb/updatestatus",i).then(function(){e.path("/step3/"+t.resources.Id)})};t.deleteImage=function(n){f.post("/api/file/delete",n).then(function(){s()})}});app.controller("step3Controller",function(n,t,i,r,u,f,e,o){var s,h;r.currentStep=3;s=u.sub;n.sub=s;h=function(){var t={};t.id=s;i.post("/api/epkb/taxpayment",t).then(function(t){n.resources=t.data;n.Images=n.resources.Images},function(n){f.error(n.data.Message)})};n.dragDrop=function(t,i){var r=[];angular.forEach(t.files,function(n){r.push(n.file)});e.upload(r,n.resources.RegNumber,n.resources.RegNumber+"_"+i).then(function(t){n.Images=t.data},function(n){swal("Oops!",n.data.Message,"info")});t.files=[]};h();n.save=function(){var r={};r.id=n.resources.Id;r.status=t.status_confirmPayment;i.post("/api/epkb/updatestatus",r).then(function(){o.path("/step4/"+n.resources.Id)},function(n){f.errorDialog(n.data.Message)})};n.deleteImage=function(n){i.post("/api/file/delete",n).then(function(){h()})}});app.controller("step4Controller",function(n,t,i,r){t.currentStep=4;n.sub=i.sub;var u=function(){var t={};t.id=n.sub;r.post("/api/epkb/taxpayment",t).then(function(t){n.resources=t.data},function(n){dialogService.error(n.data.Message)})};u()});app.controller("userController",function(n,t,i,r,u){i.path()=="/forgotpassword"&&$("#forgotmodal").modal("show");t.login=function(t){n.login(t).then(function(){n.isAdminLogin()?i.path("/admin/list"):n.authentication.user.TaxPaymentsCount>0?i.path("/profile"):i.path("/step1")},function(){})};t.passwordResetLink=function(n){u.post("/api/account/passwordResetLink",n).then(function(){swal({title:"Silahkan cek Email anda!",text:"Petunjuk untuk mereset password telah dikirim ke email anda",type:"success"},function(){swal.close();$(".modal").modal("hide")})},function(n){swal("Sorry!",n.data.Message,"info")})};t.passwordReset=function(t){if(t.Password!=t.PasswordConfirm){swal("Oops!","Pastikan password anda benar!","warning");return}t.AspNetUser={};t.UserName=i.search().id;t.Token=i.search().code;n.resetPassword(t).then(function(){swal({title:"Sukses!",text:"Pasword telah direset!",type:"success",timer:2e3,showConfirmButton:!1},function(){r(function(){swal.close();n.logout(!0);i.path("/")},0)})},function(n){swal("Sorry!",n.data.Message,"info")})}});app.controller("adminListController",function(n,t,i){t.isAdmin=!0;var r=function(){i.get("/api/admin/list").then(function(t){n.resources=t.data})};r()});app.controller("adminValidateController",function(n,t,i,r,u,f,e){i.isAdmin=!0;n.sub=t.sub;var o=function(){var t,i;for(n.v_user=[],t=0;t<5;t++)n.v_user.push(!1);for(n.v_vehicle=[],t=0;t<14;t++)n.v_vehicle.push(!1);i={};i.id=n.sub;i.status=u.status_validateData;i.rotc="true";r.post("/api/epkb/taxpayment",i).then(function(t){n.resources=t.data},function(n){f.error(n.data.Message)})};o();n.validate=function(t,i,u,o,s){var l=!0,c,h;if(angular.forEach(t,function(n){n||(l=!1)}),!l){f.errorDialog("Semua data pemilik harus dicek terlebih dahulu! Kirim pesan ke pemilik kendaraan bila diperlukan.");return}if(c=!0,angular.forEach(i,function(n){n||(c=!1)}),!c){f.errorDialog("Semua data kendaraan harus dicek terlebih dahulu! Kirim pesan ke pemilik kendaraan bila diperlukan.");return}if(s){h={};h.id=n.resources.Id;h.status=s;r.post("/api/epkb/updatestatus",h).then(function(){e.path("/admin/list")});return}if(!o){f.errorDialog("Mohon centang pernyataan bahwa anda telah memastikan semua data telah sesuai!");return}r.post("/api/admin/validate",u).then(function(){f.saveSuccess().then(function(){e.path("/admin/list")})},function(n){f.errorDialog(n.data.Message)})}});app.controller("adminConfirmPaymentController",function(n,t,i,r,u,f,e){i.isAdmin=!0;n.sub=t.sub;var o=function(){var t={};t.id=n.sub;r.post("/api/epkb/taxpayment",t).then(function(t){n.resources=t.data},function(n){u.error(n.data.Message)})};o();n.save=function(t,i){if(!t){u.errorDialog("Silahkan centang tombol konfirmasi jika anda telah memeriksa dan memastikan dana telah diterima.");return}var o={};o.id=n.resources.Id;o.status=i?i:f.status_print;r.post("/api/epkb/updatestatus",o).then(function(){e.path("/admin/list")})}});app.factory("dialogService",function(n,t){var i={},r=function(){var n=t.defer();return swal({title:"Sukses!",text:"Data telah disimpan.",timer:2e3,type:"success",showConfirmButton:!1},function(){swal.close();n.resolve()}),n.promise},u=function(n){var i=t.defer();return swal({title:"Are you sure?",text:n,type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",closeOnConfirm:!1},function(n){n?i.resolve(n):i.reject(!1)}),i.promise},f=function(n){swal("Oops!",n,"info")},e=function(n){swal("Pajak Sudah Dibayar!",n,"success")};return i.errorDialog=f,i.saveSuccess=r,i.confirmDialog=u,i});app.factory("appService",function(n,t,i,r){var u={},f=function(){try{var i=r.defer();return n.post("/api/epkb/getoptions",{}).then(function(n){u.Option=n.data;i.resolve(n.data)},function(n){t.error(n.data.Message);i.reject(n)}),i.promise}catch(f){console.log(f)}},e=function(t){var u={},i;return u.id=t,i=r.defer(),n.post("/api/epkb/userdata",u).then(function(n){i.resolve(n)},function(n){i.reject(n)}),i.promise},o=function(){u.Provinces&&u.Provinces.length>0||n.get("/api/epkb/provinces").then(function(n){u.Provinces=n.data})},s=function(t){var i=r.defer(),u;return c(t)?(u=t,u.UserName=t.UserProfile.Email,u.Password=t.Password,n.post("/api/account/register",u).then(function(n){i.resolve(n.data)},function(n){i.reject(n)}),i.promise):(i.reject(),i.promise)},h=function(t){var f=r.defer(),u;try{return u=t,u.Vehicle.IdRegion=t.Vehicle.Region.Id,u.Vehicle.Province=t.Vehicle.Province.Name,u.UserProfile.TaxPayments=[],u.UserProfile.Vehicles=[],n.post("/api/epkb/save",u).then(function(n){f.resolve(n.data);n.data!="EXIST"&&i.path("/step2/"+n.data)},function(n){f.reject(n)}),f.promise}catch(e){return console.log(e),f.promise}},c=function(n){return n.Password!=n.ConfirmPassword?(t.errorDialog("Pastikan password anda benar!"),!1):!0},l=function(t,i){var r={};r.id=t;r.msg=i;n.post("/api/epkb/sendmail",r).then(function(){swal("Sukses!","Email terkirim!","success")})};return u.status_validateData="VALIDASI DATA",u.status_waitForPayment="MENUNGGU PEMBAYARAN",u.status_confirmPayment="KONFIRMASI PEMBAYARAN",u.status_print="CETAK BUKTI",u.status_upload="UNGGAH DOKUMEN SYARAT",u.Option={},u.loadOption=f,u.loadUser=e,u.loadProvinces=o,u.saveRegistration=s,u.saveData=h,u.sendNotification=l,u});